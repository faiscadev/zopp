---
title: Database Setup
description: Configure SQLite or PostgreSQL for zopp.
---

import { Tabs, TabItem, Aside } from '@astrojs/starlight/components';

zopp supports two database backends: SQLite for simplicity and PostgreSQL for production.

## Choosing a Backend

| Feature | SQLite | PostgreSQL |
|---------|--------|------------|
| Setup complexity | None | Moderate |
| Scaling | Single server | Horizontal |
| Backups | File copy | pg_dump |
| High availability | No | Yes (replication) |
| Recommended for | Dev, small teams | Production |

## SQLite

SQLite is the default backendâ€”no configuration required.

### Basic Usage

```bash
# Default location: ~/.zopp/zopp.db
zopp-server serve

# Custom path
zopp-server serve --db /var/lib/zopp/zopp.db
```

### Docker

```bash
docker run -d \
  -v zopp-data:/data \
  ghcr.io/faiscadev/zopp-server:latest \
  serve --db /data/zopp.db
```

### Backups

SQLite databases are single files. Back up with:

```bash
# Simple copy (while server is running)
sqlite3 /var/lib/zopp/zopp.db ".backup /backup/zopp-$(date +%Y%m%d).db"

# Or stop server and copy file
cp /var/lib/zopp/zopp.db /backup/
```

### Limitations

- Single writer (concurrent reads are fine)
- Not suitable for high-availability deployments
- Database file must be on local filesystem (not NFS)

## PostgreSQL

PostgreSQL is recommended for production deployments.

### Setup

<Tabs>
  <TabItem label="Docker">
    ```bash
    docker run -d \
      --name zopp-postgres \
      -e POSTGRES_USER=zopp \
      -e POSTGRES_PASSWORD=your-secure-password \
      -e POSTGRES_DB=zopp \
      -v postgres-data:/var/lib/postgresql/data \
      -p 5432:5432 \
      postgres:16
    ```
  </TabItem>
  <TabItem label="Native">
    ```bash
    # Install PostgreSQL
    sudo apt install postgresql-16

    # Create user and database
    sudo -u postgres createuser zopp
    sudo -u postgres createdb -O zopp zopp

    # Set password
    sudo -u postgres psql -c "ALTER USER zopp PASSWORD 'your-secure-password';"
    ```
  </TabItem>
  <TabItem label="Managed">
    Use your cloud provider's managed PostgreSQL:
    - AWS RDS
    - Google Cloud SQL
    - Azure Database for PostgreSQL
    - DigitalOcean Managed Databases
    - Supabase
    - Neon
  </TabItem>
</Tabs>

### Connection String

Set the `DATABASE_URL` environment variable:

```bash
DATABASE_URL=postgres://user:password@host:5432/database zopp-server serve
```

Connection string format:
```
postgres://username:password@hostname:port/database?sslmode=require
```

### SSL/TLS Connections

For secure connections to PostgreSQL:

```bash
# Require SSL
DATABASE_URL=postgres://user:pass@host/db?sslmode=require

# Verify server certificate
DATABASE_URL=postgres://user:pass@host/db?sslmode=verify-full&sslrootcert=/path/to/ca.crt
```

### Connection Pooling

The zopp server maintains a connection pool. Configure with query parameters:

```bash
DATABASE_URL=postgres://user:pass@host/db?max_connections=20
```

### Backups

```bash
# Full backup
pg_dump -h localhost -U zopp zopp > /backup/zopp-$(date +%Y%m%d).sql

# Compressed backup
pg_dump -h localhost -U zopp zopp | gzip > /backup/zopp-$(date +%Y%m%d).sql.gz

# Restore
psql -h localhost -U zopp zopp < /backup/zopp-20250115.sql
```

### High Availability

For high availability, use PostgreSQL replication:

```yaml
# Example with Cloud SQL
DATABASE_URL=postgres://zopp:pass@/zopp?host=/cloudsql/project:region:instance
```

Or set up streaming replication with a primary and standby.

## Migrations

zopp automatically runs database migrations on startup. No manual migration is needed.

<Aside type="note">
  When upgrading zopp, migrations are applied automatically. The server handles schema changes gracefully.
</Aside>

## Schema

The zopp database stores:

| Table | Contents |
|-------|----------|
| `users` | User metadata (email) |
| `principals` | Principal credentials (public keys) |
| `workspaces` | Workspace metadata |
| `workspace_principals` | Wrapped KEKs per principal |
| `projects` | Project metadata |
| `environments` | Environment metadata and wrapped DEKs |
| `secrets` | Encrypted secret ciphertexts |
| `invites` | Pending invites (hashed tokens) |
| `permissions` | RBAC permissions |
| `groups` | User groups |
| `audit_log` | Audit trail |

<Aside type="caution">
  The database contains encrypted secrets and wrapped keys. Never expose it publicly. Treat database backups as sensitive.
</Aside>

## Performance Tuning

### SQLite

For better performance with SQLite:

```bash
# Use WAL mode (default in zopp)
sqlite3 /var/lib/zopp/zopp.db "PRAGMA journal_mode=WAL;"
```

### PostgreSQL

Recommended PostgreSQL settings for zopp:

```ini
# postgresql.conf
max_connections = 100
shared_buffers = 256MB
work_mem = 4MB
maintenance_work_mem = 64MB
```

## Troubleshooting

### "Database is locked" (SQLite)

This occurs when multiple processes try to write simultaneously. Ensure only one zopp-server instance accesses the database.

### "Connection refused" (PostgreSQL)

Check:
1. PostgreSQL is running: `pg_isready`
2. Network connectivity: `telnet hostname 5432`
3. Authentication: Check `pg_hba.conf`
4. Credentials: Verify username/password

### Slow queries

Enable query logging:

```bash
# PostgreSQL
ALTER SYSTEM SET log_min_duration_statement = 100;  -- Log queries > 100ms
SELECT pg_reload_conf();
```

## Next Steps

- [TLS Configuration](/zopp/self-hosting/tls/) - Secure database connections
- [Server Deployment](/zopp/self-hosting/server/) - Complete server setup
