---
title: TLS Configuration
description: Secure zopp with TLS and mutual TLS.
---

import { Tabs, TabItem, Steps, Aside } from '@astrojs/starlight/components';

TLS encrypts communication between clients and the zopp server. This guide covers setting up TLS and optional mutual TLS (mTLS).

## Overview

| Mode | Client → Server | Server → Client |
|------|-----------------|-----------------|
| No TLS | Plaintext | Plaintext |
| TLS | Encrypted | Encrypted |
| mTLS | Encrypted + Client cert | Encrypted |

<Aside type="caution">
  Always use TLS in production. Without TLS, authentication tokens are transmitted in plaintext.
</Aside>

## TLS Setup

### Obtain Certificates

<Tabs>
  <TabItem label="Let's Encrypt">
    For public servers, use Let's Encrypt:

    ```bash
    # Install certbot
    sudo apt install certbot

    # Obtain certificate
    sudo certbot certonly --standalone -d zopp.example.com

    # Certificates are at:
    # /etc/letsencrypt/live/zopp.example.com/fullchain.pem
    # /etc/letsencrypt/live/zopp.example.com/privkey.pem
    ```
  </TabItem>
  <TabItem label="Self-Signed">
    For internal/development use:

    ```bash
    # Generate CA
    openssl genrsa -out ca.key 4096
    openssl req -new -x509 -days 3650 -key ca.key -out ca.crt \
      -subj "/CN=zopp-ca"

    # Generate server certificate
    openssl genrsa -out server.key 2048
    openssl req -new -key server.key -out server.csr \
      -subj "/CN=zopp.example.com"

    # Sign with CA
    openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key \
      -CAcreateserial -out server.crt \
      -extfile <(echo "subjectAltName=DNS:zopp.example.com,DNS:localhost,IP:127.0.0.1")
    ```

    <Aside type="note">
      Distribute `ca.crt` to clients. Keep `ca.key` and `server.key` secure.
    </Aside>
  </TabItem>
</Tabs>

### Configure the Server

<Tabs>
  <TabItem label="CLI">
    ```bash
    zopp-server serve \
      --tls-cert /etc/zopp/server.crt \
      --tls-key /etc/zopp/server.key
    ```
  </TabItem>
  <TabItem label="Environment">
    ```bash
    export ZOPP_TLS_CERT=/etc/zopp/server.crt
    export ZOPP_TLS_KEY=/etc/zopp/server.key
    zopp-server serve
    ```
  </TabItem>
  <TabItem label="Docker">
    ```bash
    docker run -d \
      -v /etc/zopp:/certs:ro \
      -p 50051:50051 \
      ghcr.io/faiscadev/zopp-server:latest \
      serve --tls-cert /certs/server.crt --tls-key /certs/server.key
    ```
  </TabItem>
</Tabs>

### Configure Clients

Clients automatically use TLS when connecting to `https://` URLs:

```bash
# TLS enabled (Let's Encrypt or trusted CA)
zopp --server https://zopp.example.com:50051 workspace list

# Self-signed certificate (provide CA)
zopp --server https://zopp.example.com:50051 --tls-ca-cert /path/to/ca.crt workspace list

# Or via environment
export ZOPP_SERVER=https://zopp.example.com:50051
export ZOPP_TLS_CA_CERT=/path/to/ca.crt
zopp workspace list
```

## Mutual TLS (mTLS)

mTLS requires clients to present certificates, providing additional authentication.

### Generate Client Certificates

<Steps>

1. Generate client key and CSR:
   ```bash
   openssl genrsa -out client.key 2048
   openssl req -new -key client.key -out client.csr \
     -subj "/CN=alice@example.com"
   ```

2. Sign with CA:
   ```bash
   openssl x509 -req -days 365 -in client.csr -CA ca.crt -CAkey ca.key \
     -CAcreateserial -out client.crt
   ```

3. Distribute to client:
   - `client.crt` - Client certificate
   - `client.key` - Client private key
   - `ca.crt` - CA certificate

</Steps>

### Configure Server for mTLS

```bash
zopp-server serve \
  --tls-cert /etc/zopp/server.crt \
  --tls-key /etc/zopp/server.key \
  --tls-client-ca /etc/zopp/ca.crt
```

With `--tls-client-ca`, the server requires clients to present a certificate signed by the specified CA.

### Configure Client for mTLS

```bash
zopp --server https://zopp.example.com:50051 \
  --tls-ca-cert /path/to/ca.crt \
  --tls-cert /path/to/client.crt \
  --tls-key /path/to/client.key \
  workspace list
```

<Aside type="note">
  mTLS client certificate support is in development. Check the latest release for availability.
</Aside>

## Certificate Rotation

### Automatic (Let's Encrypt)

Set up auto-renewal:

```bash
# Certbot auto-renewal
sudo certbot renew

# Reload server after renewal
sudo systemctl reload zopp-server
```

### Manual

<Steps>

1. Generate new certificate
2. Deploy to server
3. Reload or restart server:
   ```bash
   sudo systemctl reload zopp-server
   ```
4. Update client CA certificate if CA changed

</Steps>

## Kubernetes TLS

### Using cert-manager

```yaml
# certificate.yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: zopp-server-tls
  namespace: zopp
spec:
  secretName: zopp-server-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - zopp.example.com
```

```yaml
# values.yaml for Helm
server:
  tls:
    enabled: true
    existingSecret: zopp-server-tls
```

### Self-Signed in Kubernetes

```bash
# Create TLS secret
kubectl create secret tls zopp-server-tls \
  --cert=server.crt \
  --key=server.key \
  -n zopp
```

## Troubleshooting

### "Certificate verify failed"

The client doesn't trust the server's certificate:

```bash
# Provide CA certificate
zopp --server https://... --tls-ca-cert /path/to/ca.crt workspace list
```

### "Handshake failed"

Check:
1. Certificate matches hostname
2. Certificate is not expired: `openssl x509 -in server.crt -noout -dates`
3. Key matches certificate: `openssl x509 -in server.crt -noout -modulus | md5sum` should match `openssl rsa -in server.key -noout -modulus | md5sum`

### "Connection reset"

The server may not have TLS enabled. Check server logs and ensure `--tls-cert` and `--tls-key` are provided.

## Security Recommendations

1. **Use TLS everywhere** - Never run production without TLS
2. **Use strong key sizes** - RSA 2048+ or ECDSA P-256+
3. **Rotate certificates** - Before expiration, ideally automated
4. **Protect private keys** - Restrict file permissions (600)
5. **Consider mTLS** - For high-security environments
6. **Monitor expiration** - Alert before certificates expire

## Next Steps

- [Server Deployment](/zopp/self-hosting/server/) - Complete server setup
- [Security Architecture](/zopp/security/architecture/) - Understand zopp's security model
