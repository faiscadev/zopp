"use strict";(globalThis.webpackChunkzopp_docs=globalThis.webpackChunkzopp_docs||[]).push([[3999],{5994(e,r,n){n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>d,default:()=>o,frontMatter:()=>c,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"security/architecture","title":"Security Architecture","description":"How zopp\'s zero-knowledge encryption works.","source":"@site/docs/security/architecture.md","sourceDirName":"security","slug":"/security/architecture","permalink":"/zopp/security/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/faiscadev/zopp/tree/main/docs/docs/security/architecture.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Security Architecture","description":"How zopp\'s zero-knowledge encryption works."},"sidebar":"docs","previous":{"title":"Security","permalink":"/zopp/security/"},"next":{"title":"Cryptographic Primitives","permalink":"/zopp/security/cryptography"}}');var t=n(4848),s=n(8453);const c={sidebar_position:2,title:"Security Architecture",description:"How zopp's zero-knowledge encryption works."},d="Security Architecture",a={},l=[{value:"Key Hierarchy",id:"key-hierarchy",level:2},{value:"Principal Keys",id:"principal-keys",level:2},{value:"Workspace KEK",id:"workspace-kek",level:2},{value:"KEK Wrapping",id:"kek-wrapping",level:3},{value:"Environment DEK",id:"environment-dek",level:2},{value:"Secret Encryption",id:"secret-encryption",level:2},{value:"Invite Flow",id:"invite-flow",level:2},{value:"Request Authentication",id:"request-authentication",level:2},{value:"Data at Rest",id:"data-at-rest",level:2},{value:"Next Steps",id:"next-steps",level:2}];function h(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"security-architecture",children:"Security Architecture"})}),"\n",(0,t.jsx)(r.p,{children:"This page explains how zopp achieves zero-knowledge encryption."}),"\n",(0,t.jsx)(r.h2,{id:"key-hierarchy",children:"Key Hierarchy"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"User\n \u2514\u2500\u2500 Principal (device)\n      \u251c\u2500\u2500 Ed25519 keypair (signing/authentication)\n      \u2514\u2500\u2500 X25519 keypair (encryption)\n           \u2514\u2500\u2500 Workspace\n                \u2514\u2500\u2500 KEK (Key Encryption Key, wrapped per-principal)\n                     \u2514\u2500\u2500 Environment\n                          \u2514\u2500\u2500 DEK (Data Encryption Key, wrapped with KEK)\n                               \u2514\u2500\u2500 Secrets (encrypted with DEK)\n"})}),"\n",(0,t.jsx)(r.h2,{id:"principal-keys",children:"Principal Keys"}),"\n",(0,t.jsx)(r.p,{children:"Each principal (device/credential) has two keypairs:"}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Key Type"}),(0,t.jsx)(r.th,{children:"Purpose"}),(0,t.jsx)(r.th,{children:"Usage"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Ed25519"}),(0,t.jsx)(r.td,{children:"Signing"}),(0,t.jsx)(r.td,{children:"Authenticate requests to server"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"X25519"}),(0,t.jsx)(r.td,{children:"Encryption"}),(0,t.jsx)(r.td,{children:"ECDH for key wrapping"})]})]})]}),"\n",(0,t.jsx)(r.p,{children:"Keys are generated client-side and the private keys never leave the device."}),"\n",(0,t.jsx)(r.h2,{id:"workspace-kek",children:"Workspace KEK"}),"\n",(0,t.jsx)(r.p,{children:"The Key Encryption Key (KEK) protects all data within a workspace:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Generated when workspace is created (32 random bytes)"}),"\n",(0,t.jsx)(r.li,{children:"Wrapped separately for each principal with access"}),"\n",(0,t.jsx)(r.li,{children:"Wrapping uses X25519 ECDH + XChaCha20-Poly1305"}),"\n"]}),"\n",(0,t.jsx)(r.h3,{id:"kek-wrapping",children:"KEK Wrapping"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:'1. Generate ephemeral X25519 keypair\n2. Perform ECDH: shared_secret = ECDH(ephemeral_private, principal_public)\n3. Derive key: wrap_key = HKDF(shared_secret, "zopp-kek-wrap")\n4. Generate nonce: nonce = random(24 bytes)\n5. Encrypt: wrapped_kek = XChaCha20-Poly1305(wrap_key, nonce, kek)\n6. Store: (ephemeral_public, wrapped_kek, nonce)\n'})}),"\n",(0,t.jsx)(r.p,{children:"The server stores only the wrapped form. Unwrapping requires the principal's private key."}),"\n",(0,t.jsx)(r.h2,{id:"environment-dek",children:"Environment DEK"}),"\n",(0,t.jsx)(r.p,{children:"The Data Encryption Key (DEK) encrypts secrets within an environment:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Generated when environment is created (32 random bytes)"}),"\n",(0,t.jsx)(r.li,{children:"Wrapped with the workspace KEK"}),"\n",(0,t.jsx)(r.li,{children:"Stored on server in wrapped form"}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"secret-encryption",children:"Secret Encryption"}),"\n",(0,t.jsx)(r.p,{children:"Secrets are encrypted with XChaCha20-Poly1305 AEAD:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"plaintext = secret_value\nkey = environment_dek\nnonce = random_24_bytes\naad = workspace_id || project_id || environment_id || secret_key\nciphertext = XChaCha20-Poly1305.encrypt(key, nonce, plaintext, aad)\n"})}),"\n",(0,t.jsx)(r.p,{children:"The AAD (Additional Authenticated Data) cryptographically binds the secret to its location."}),"\n",(0,t.jsx)(r.h2,{id:"invite-flow",children:"Invite Flow"}),"\n",(0,t.jsx)(r.p,{children:"Workspace invites securely transfer the KEK to new members:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Creator"}),": Generates random 32-byte invite secret"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Creator"}),": Wraps KEK with invite secret"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Creator"}),": Sends ",(0,t.jsx)(r.code,{children:"hash(invite_secret)"})," to server"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Invitee"}),": Receives full invite code (includes encrypted KEK)"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Invitee"}),": Unwraps KEK with invite secret"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Invitee"}),": Re-wraps KEK for their own principal"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Server"}),": Verifies hash, stores new wrapped KEK"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"The server only sees the hash\u2014never the invite secret or plaintext KEK."}),"\n",(0,t.jsx)(r.h2,{id:"request-authentication",children:"Request Authentication"}),"\n",(0,t.jsx)(r.p,{children:"All API requests are authenticated with Ed25519 signatures:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"timestamp = current_unix_timestamp\nmessage = timestamp || request_body\nsignature = Ed25519.sign(principal_private_key, message)\n"})}),"\n",(0,t.jsx)(r.p,{children:"The signature and timestamp are sent as gRPC metadata. The server verifies:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Signature is valid"}),"\n",(0,t.jsx)(r.li,{children:"Timestamp is within acceptable window (prevents replay)"}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"data-at-rest",children:"Data at Rest"}),"\n",(0,t.jsx)(r.p,{children:"What the server stores:"}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Data"}),(0,t.jsx)(r.th,{children:"Format"}),(0,t.jsx)(r.th,{children:"Can Server Decrypt?"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Secrets"}),(0,t.jsx)(r.td,{children:"Ciphertext + nonce"}),(0,t.jsx)(r.td,{children:"No"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"DEKs"}),(0,t.jsx)(r.td,{children:"Wrapped with KEK"}),(0,t.jsx)(r.td,{children:"No"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"KEKs"}),(0,t.jsx)(r.td,{children:"Wrapped per-principal"}),(0,t.jsx)(r.td,{children:"No"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Public keys"}),(0,t.jsx)(r.td,{children:"Plaintext"}),(0,t.jsx)(r.td,{children:"N/A (public)"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Invite hashes"}),(0,t.jsx)(r.td,{children:"SHA256"}),(0,t.jsx)(r.td,{children:"No (hash only)"})]})]})]}),"\n",(0,t.jsx)(r.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.a,{href:"/security/cryptography",children:"Cryptography"})," - Primitive details"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.a,{href:"/guides/core-concepts",children:"Core Concepts"})," - Key hierarchy overview"]}),"\n"]})]})}function o(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453(e,r,n){n.d(r,{R:()=>c,x:()=>d});var i=n(6540);const t={},s=i.createContext(t);function c(e){const r=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),i.createElement(s.Provider,{value:r},e.children)}}}]);